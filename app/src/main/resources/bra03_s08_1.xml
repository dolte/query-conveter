<mapper namespace="kr.or.komca.center..mapper.Mapper">
<select id="SQLauto_demd_select_SEL5" parameterType="" resultType="">
SELECT
	XC.BRAN_CD,
	XB.UPSO_CD,
	XC.UPSO_NM,
	XC.CLIENT_NUM,
	XB.BANK_CD,
	XB.AUTO_ACCNNUM,
	XB.RESINUM,
	XA.START_YRMN,
	XC.MCHNDAESU,
	XC.MNGEMSTR_NM,
	XA.BSTYP_CD || XA.UPSO_GRAD UPSO_GRAD,
	XA.TOT_DEMD_AMT,
	XA.TOT_ADDT_AMT,
	XA.TOT_EADDT_AMT,
	XA.DSCT_AMT,
	XA.DEMD_MMCNT,
	XA.MONPRNCFEE,
	XE.BANK_NM,
	XF.DEPT_NM,
	XB.RECEPTION_GBN
FROM
	GIBU.TBRA_DEMD_AUTO XA,
	(
		SELECT
			A.UPSO_CD,
			SUBSTR(A.BANK_CD, 1, 3) BANK_CD,
			A.AUTO_ACCNNUM,
			DECODE(
				LENGTH(A.RESINUM),
				13,
				SUBSTR(A.RESINUM, 0, 6) || '0000000',
				A.RESINUM
			) AS RESINUM,
			A.RECEPTION_GBN
		FROM
			GIBU.TBRA_UPSO_AUTO A,
			(
				SELECT
					UPSO_CD,
					MAX(AUTO_NUM) AUTO_NUM
				FROM
					GIBU.TBRA_UPSO_AUTO
				WHERE
					TERM_YN = 'N'
				GROUP BY
					UPSO_CD
			) B
		WHERE
			A.UPSO_CD = B.UPSO_CD
			AND A.AUTO_NUM = B.AUTO_NUM
			AND A.AUTO_ACCNNUM IS NOT NULL
	) XB,
	GIBU.TBRA_UPSO XC,
	ACCT.TCAC_BANK XE,
	INSA.TCPM_DEPT XF
WHERE
	XA.DEMD_YRMN = # { demdYrmn }
	AND XB.UPSO_CD = XA.UPSO_CD
	AND XC.UPSO_CD = XA.UPSO_CD
	AND XE.BANK_CD = XB.BANK_CD
	AND XF.GIBU = XC.BRAN_CD
	AND XA.DEMD_GBN = '31'
	AND XA.TOT_DEMD_AMT > 0
	AND XA.UPSO_CD NOT IN (
		SELECT
			UPSO_CD
		FROM
			GIBU.TBRA_DEMD_REPT
		WHERE
			DEMD_YRMN = # { demdYrmn }
	)
	AND XA.TRNF_RSLT IS NOT NULL
	AND XC.CLSBS_YRMN IS NULL
	AND MONTHS_BETWEEN(XA.END_YRMN || '01', XA.START_YRMN || '01') + 1 > (
		SELECT
			COUNT(*)
		FROM
			GIBU.TBRA_NOTE
		WHERE
			UPSO_CD = XB.UPSO_CD
			AND NOTE_YRMN BETWEEN XA.START_YRMN
			AND XA.END_YRMN
	)
ORDER BY
	XC.BRAN_CD,
	XB.UPSO_CD
</select>

<select id="SQLauto_demd_select_SEL13" parameterType="" resultType="">
SELECT
	GIBU.FT_GET_BSTYP_NM(XA.BSTYP_CD) AS BSTYP_NM,
	COUNT(1) AS DEMD_CNT,
	SUM(XA.TOT_DEMD_AMT) AS TOT_DEMD_AMT
FROM
	GIBU.TBRA_DEMD_AUTO XA,
	(
		SELECT
			A.UPSO_CD
		FROM
			GIBU.TBRA_UPSO_AUTO A,
			(
				SELECT
					UPSO_CD,
					MAX(AUTO_NUM) AS AUTO_NUM
				FROM
					GIBU.TBRA_UPSO_AUTO
				WHERE
					TERM_YN = 'N'
				GROUP BY
					UPSO_CD
			) B
		WHERE
			A.UPSO_CD = B.UPSO_CD
			AND A.AUTO_NUM = B.AUTO_NUM
			AND A.AUTO_ACCNNUM IS NOT NULL
	) XB,
	GIBU.TBRA_UPSO XC
WHERE
	XA.DEMD_YRMN = # { demdYrmn }
	AND XB.UPSO_CD = XA.UPSO_CD
	AND XC.UPSO_CD = XA.UPSO_CD
	AND XA.DEMD_GBN = '31'
	AND XA.TOT_DEMD_AMT > 0
	AND XA.UPSO_CD NOT IN (
		SELECT
			UPSO_CD
		FROM
			GIBU.TBRA_DEMD_REPT
		WHERE
			DEMD_YRMN = # { demdYrmn }
	)
	AND XA.TRNF_RSLT IS NOT NULL
	AND XC.CLSBS_YRMN IS NULL
	AND MONTHS_BETWEEN(XA.END_YRMN || '01', XA.START_YRMN || '01') + 1 > (
		SELECT
			COUNT(*)
		FROM
			GIBU.TBRA_NOTE
		WHERE
			UPSO_CD = XB.UPSO_CD
			AND NOTE_YRMN BETWEEN XA.START_YRMN
			AND XA.END_YRMN
	)
GROUP BY
	XA.BSTYP_CD
ORDER BY
	1
</select>

<select id="SQLauto_demd_select_SEL6" parameterType="" resultType="">
SELECT
	MIN (YRMNDAY) PAY_DAY
FROM
	INSA.TDUT_CALENDAR
WHERE
	YRMNDAY BETWEEN TO_CHAR(
		ADD_MONTHS(TO_DATE(# { yrmnday }, 'YYYYMM'), 1),
		'YYYYMM'
	) || '03'
	AND TO_CHAR(
		ADD_MONTHS(TO_DATE(# { yrmnday }, 'YYYYMM'), 1),
		'YYYYMM'
	) || '10'
	AND HOLIDAY_YN = '0'
</select>

<update id="SQLauto_demd_select_XIUD10" parameterType="">
UPDATE
	GIBU.TBRA_DEMD_AUTO
SET
	TRNF_RSLT = # { trnfRslt },
	MODPRES_ID = # { modpresId },
	MOD_DATE = SYSDATE,
	PROC_GBN = # { procGbn },
	SEND_DATE2 = SYSDATE
WHERE
	DEMD_YRMN = # { demdYrmn }
	AND UPSO_CD IN (
		SELECT
			DISTINCT XB.UPSO_CD
		FROM
			GIBU.TBRA_DEMD_AUTO XA,
			(
				SELECT
					A.UPSO_CD
				FROM
					GIBU.TBRA_UPSO_AUTO A,
					(
						SELECT
							UPSO_CD,
							MAX(AUTO_NUM) AUTO_NUM
						FROM
							GIBU.TBRA_UPSO_AUTO
						WHERE
							TERM_YN = 'N'
						GROUP BY
							UPSO_CD
					) B
				WHERE
					A.UPSO_CD = B.UPSO_CD
					AND A.AUTO_NUM = B.AUTO_NUM
					AND A.AUTO_ACCNNUM IS NOT NULL
			) XB,
			GIBU.TBRA_UPSO XC
		WHERE
			XA.DEMD_YRMN = # { demdYrmn }
			AND XB.UPSO_CD = XA.UPSO_CD
			AND XC.UPSO_CD = XA.UPSO_CD
			AND XA.DEMD_GBN = '31'
			AND XA.TOT_DEMD_AMT > 0
			AND XA.UPSO_CD NOT IN (
				SELECT
					UPSO_CD
				FROM
					GIBU.TBRA_DEMD_REPT
				WHERE
					DEMD_YRMN = # { demdYrmn }
			)
			AND XA.TRNF_RSLT IS NOT NULL
			AND XC.CLSBS_YRMN IS NULL
			AND MONTHS_BETWEEN(XA.END_YRMN || '01', XA.START_YRMN || '01') + 1 > (
				SELECT
					COUNT(*)
				FROM
					GIBU.TBRA_NOTE
				WHERE
					UPSO_CD = XB.UPSO_CD
					AND NOTE_YRMN BETWEEN XA.START_YRMN
					AND XA.END_YRMN
			)
	)
</update>

<select id="SQLauto_demd_select_SEL1" parameterType="" resultType="">
SELECT
	XC.BRAN_CD,
	XB.UPSO_CD,
	XC.UPSO_NM,
	XC.CLIENT_NUM,
	XB.BANK_CD,
	XB.AUTO_ACCNNUM,
	XB.RESINUM,
	XA.START_YRMN,
	XC.MCHNDAESU,
	XC.MNGEMSTR_NM,
	XA.BSTYP_CD || XA.UPSO_GRAD UPSO_GRAD,
	XA.TOT_DEMD_AMT,
	XA.TOT_ADDT_AMT,
	XA.TOT_EADDT_AMT,
	XA.DSCT_AMT,
	XA.DEMD_MMCNT,
	XA.MONPRNCFEE,
	XE.BANK_NM,
	XF.DEPT_NM,
	XB.RECEPTION_GBN
FROM
	GIBU.TBRA_DEMD_AUTO XA,
	(
		SELECT
			A.UPSO_CD,
			SUBSTR(A.BANK_CD, 1, 3) BANK_CD,
			A.AUTO_ACCNNUM,
			DECODE(
				LENGTH(A.RESINUM),
				13,
				SUBSTR(A.RESINUM, 0, 6) || '0000000',
				A.RESINUM
			) AS RESINUM,
			A.RECEPTION_GBN
		FROM
			GIBU.TBRA_UPSO_AUTO A,
			(
				SELECT
					UPSO_CD,
					MAX(AUTO_NUM) AUTO_NUM
				FROM
					GIBU.TBRA_UPSO_AUTO
				WHERE
					TERM_YN = 'N'
				GROUP BY
					UPSO_CD
			) B
		WHERE
			A.UPSO_CD = B.UPSO_CD
			AND A.AUTO_NUM = B.AUTO_NUM
			AND A.AUTO_ACCNNUM IS NOT NULL
	) XB,
	GIBU.TBRA_UPSO XC,
	ACCT.TCAC_BANK XE,
	INSA.TCPM_DEPT XF
WHERE
	XA.DEMD_YRMN = # { demdYrmn }
	AND XB.UPSO_CD = XA.UPSO_CD
	AND XC.UPSO_CD = XA.UPSO_CD
	AND XE.BANK_CD = XB.BANK_CD
	AND XF.GIBU = XC.BRAN_CD
	AND XA.DEMD_GBN = '31'
	AND XA.TOT_DEMD_AMT > 0
ORDER BY
	XC.BRAN_CD,
	XB.UPSO_CD
</select>

<select id="SQLauto_demd_select_SEL12" parameterType="" resultType="">
SELECT
	GIBU.FT_GET_BSTYP_NM(XA.BSTYP_CD) AS BSTYP_NM,
	COUNT(1) AS DEMD_CNT,
	SUM(XA.TOT_DEMD_AMT) AS TOT_DEMD_AMT
FROM
	GIBU.TBRA_DEMD_AUTO XA,
	(
		SELECT
			A.UPSO_CD
		FROM
			GIBU.TBRA_UPSO_AUTO A,
			(
				SELECT
					UPSO_CD,
					MAX(AUTO_NUM) AUTO_NUM
				FROM
					GIBU.TBRA_UPSO_AUTO
				WHERE
					TERM_YN = 'N'
				GROUP BY
					UPSO_CD
			) B
		WHERE
			A.UPSO_CD = B.UPSO_CD
			AND A.AUTO_NUM = B.AUTO_NUM
			AND A.AUTO_ACCNNUM IS NOT NULL
	) XB
WHERE
	XA.DEMD_YRMN = # { demdYrmn }
	AND XB.UPSO_CD = XA.UPSO_CD
	AND XA.DEMD_GBN = '31'
	AND XA.TOT_DEMD_AMT > 0
GROUP BY
	XA.BSTYP_CD
ORDER BY
	1
</select>

<select id="SQLauto_demd_select_SEL2" parameterType="" resultType="">
SELECT
	MIN (YRMNDAY) PAY_DAY
FROM
	INSA.TDUT_CALENDAR
WHERE
	YRMNDAY BETWEEN # { yrmnday } || '23'
	AND SUBSTR(# { yrmnday }, 1, 6) || '31'
	AND HOLIDAY_YN = '0'
</select>

<select id="SQLauto_demd_select_SEL10" parameterType="" resultType="">
SELECT
	MIN (YRMNDAY) PAY_DAY
FROM
	INSA.TDUT_CALENDAR
WHERE
	YRMNDAY BETWEEN TO_CHAR(
		ADD_MONTHS(TO_DATE(# { fromdate }, 'YYYYMMDD'), 1),
		'YYYYMM'
	) || SUBSTR(# { fromdate }, 7, 2)
	AND TO_CHAR(
		ADD_MONTHS(TO_DATE(# { fromdate }, 'YYYYMMDD'), 1),
		'YYYYMM'
	) || SUBSTR(# { todate }, 7, 2)
	AND HOLIDAY_YN = '0'
</select>

<update id="SQLauto_demd_select_XIUD14" parameterType="">
UPDATE
	GIBU.TBRA_DEMD_AUTO
SET
	PROC_GBN = # { procGbn },
	SEND_DATE1 = SYSDATE
WHERE
	DEMD_YRMN = # { demdYrmn }
	AND UPSO_CD IN (
		SELECT
			XB.UPSO_CD
		FROM
			GIBU.TBRA_DEMD_AUTO XA,
			(
				SELECT
					A.UPSO_CD,
					SUBSTR(A.BANK_CD, 1, 3) BANK_CD,
					A.AUTO_ACCNNUM,
					A.RESINUM
				FROM
					GIBU.TBRA_UPSO_AUTO A,
					(
						SELECT
							UPSO_CD,
							MAX(AUTO_NUM) AUTO_NUM
						FROM
							GIBU.TBRA_UPSO_AUTO
						WHERE
							TERM_YN = 'N'
						GROUP BY
							UPSO_CD
					) B
				WHERE
					A.UPSO_CD = B.UPSO_CD
					AND A.AUTO_NUM = B.AUTO_NUM
					AND A.AUTO_ACCNNUM IS NOT NULL
			) XB,
			GIBU.TBRA_UPSO XC,
			ACCT.TCAC_BANK XE,
			INSA.TCPM_DEPT XF
		WHERE
			XA.DEMD_YRMN = # { demdYrmn }
			AND XB.UPSO_CD = XA.UPSO_CD
			AND XC.UPSO_CD = XA.UPSO_CD
			AND XE.BANK_CD = XB.BANK_CD
			AND XF.GIBU = XC.BRAN_CD
			AND XA.DEMD_GBN = '31'
			AND XA.TOT_DEMD_AMT > 0
	)
</update>

</mapper>